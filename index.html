<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë˜íŒŒ ë“í…œ ìœ íš¨ì„± ê²€ì‚¬ê¸°</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            /* max-width: 900px; */
            margin: 0 auto;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        h1 {
            color: #1a1a1a;
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            max-width: 600px;
        }

        #characterNameInput {
            flex-grow: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        #searchButton {
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: white;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #searchButton:hover {
            background-color: #0056b3;
        }

        #searchButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #status {
            text-align: center;
            margin: 20px 0;
            font-size: 1.1em;
            color: #555;
            font-weight: bold;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th,
        .results-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 14px;
        }

        .results-table th {
            background-color: #f9f9f9;
        }

        /* í…Œì´ë¸” í–‰ (<tr>)ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ ìŠ¤íƒ€ì¼ */
        .my-results-table tr:hover {
            /* ë°°ê²½ìƒ‰ì„ ì‚´ì§ ë°ê±°ë‚˜ ì–´ë‘¡ê²Œ ë³€ê²½ */
            background-color: #f5f5f5;

            /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ë¥¼ ì¶”ê°€í•˜ì—¬ ë³€í™”ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ë§Œë“­ë‹ˆë‹¤. */
            transition: background-color 0.3s ease;

            /* ì„ íƒ ì‚¬í•­: í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ëŒ€ë¹„ë˜ê²Œ ë³€ê²½í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. */
            /* color: #111; */
        }

        /* í…Œì´ë¸”ì˜ ê¸°ë³¸ í–‰ ìŠ¤íƒ€ì¼ (ì„ íƒ ì‚¬í•­: ëŒ€ë¹„ë¥¼ ìœ„í•´ ê¸°ë³¸ í–‰ì— ì˜…ì€ ì¤„ë¬´ëŠ¬ë¥¼ ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤) */
        .results-table-table tr:nth-child(even) {
            background-color: #fafafa;
        }

        /* ë§ˆìš°ìŠ¤ê°€ ì˜¬ë¼ê°€ì§€ ì•Šì€ ê¸°ë³¸ ìƒíƒœì˜ í–‰ */
        .results-table-table tr {
            /* transition ì†ì„±ì„ ê¸°ë³¸ ìƒíƒœì—ë„ ë„£ì–´ì¤˜ì•¼ hoverê°€ ëë‚  ë•Œë„ ë¶€ë“œëŸ½ê²Œ ëŒì•„ì˜µë‹ˆë‹¤. */
            transition: background-color 0.3s ease;
        }

        .valid-true {
            color: #28a745;
            font-weight: bold;
        }

        .valid-false {
            color: #dc3545;
        }

        /* í™•ë¥  ì…€ ìŠ¤íƒ€ì¼ */
        .probability-cell {
            font-weight: bold;
            text-align: center !important;
            padding: 8px;
            border-radius: 4px;
        }

        /* 4êµ¬ê°„ ìŠ¤íƒ€ì¼ ì •ì˜ (0%~100%) */

        /* êµ¬ê°„ 1: 0% ~ 25% (ê°€ì¥ ë‚®ì€ í™•ë¥ , ë‚˜ì¨ - ë¹¨ê°•/ì£¼í™©) */
        .prob-low {
            background-color: #ff9999;
            /* ë°ì€ ë¹¨ê°• */
            color: #800000;
        }

        /* êµ¬ê°„ 2: 26% ~ 50% (ë³´í†µ - ë…¸ë‘) */
        .prob-mid-low {
            background-color: #ffda6a;
            /* ë…¸ë€ìƒ‰ */
            color: #995c00;
        }

        /* êµ¬ê°„ 3: 51% ~ 75% (ì¢‹ìŒ - ì—°ë‘) */
        .prob-mid-high {
            background-color: #b3e6b3;
            /* ë°ì€ ë…¹ìƒ‰ */
            color: #004d00;
        }

        /* êµ¬ê°„ 4: 76% ~ 100% (ê°€ì¥ ë†’ì€ í™•ë¥ , ë§¤ìš° ì¢‹ìŒ - íŒŒë‘/ì´ˆë¡) */
        .prob-high {
            background-color: #8cd98c;
            /* ì§„í•œ ë…¹ìƒ‰ */
            color: #003300;
        }

        /* ìœ íš¨ í™•ë¥ ì€ ë‚®ì•˜ëŠ”ë° ì„±ê³µí•œ ê²½ìš° (ìš´ì´ ì¢‹ìŒ - ë…¹ìƒ‰ ê°•ì¡°) */
        .result-success-low-prob {
            font-weight: bold;
            background-color: #d4edda;
            /* ë°ì€ ì´ˆë¡ìƒ‰ ë°°ê²½ */
            color: #155724;
            /* ì§™ì€ ì´ˆë¡ìƒ‰ í…ìŠ¤íŠ¸ */
            border: 1px solid #c3e6cb;
        }

        /* ìœ íš¨ í™•ë¥ ì€ ë†’ì•˜ëŠ”ë° ì‹¤íŒ¨í•œ ê²½ìš° (ìš´ì´ ë‚˜ì¨ - ë¹¨ê°„ìƒ‰ ê°•ì¡°) */
        .result-fail-high-prob {
            font-weight: bold;
            background-color: #f8d7da;
            /* ë°ì€ ë¹¨ê°„ìƒ‰ ë°°ê²½ */
            color: #721c24;
            /* ì§™ì€ ë¹¨ê°„ìƒ‰ í…ìŠ¤íŠ¸ */
            border: 1px solid #f5c6cb;
        }

        /* ì¼ë°˜ì ì¸ ì„±ê³µ/ì‹¤íŒ¨ í‘œì‹œ (ê²½ê³ ê°€ í•„ìš” ì—†ëŠ” ê²½ìš°) */
        .result-normal {
            font-weight: normal;
            background-color: transparent;
            color: inherit;
        }

        /* ì¥ì°© ì¤‘ì¸ ì„¸íŠ¸ ì•„ì´í…œ í–‰ ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .highlight-set {
            background-color: #fffacd;
            /* ì—°í•œ ë…¸ë€ìƒ‰ */
            font-weight: bold;
        }

        /* 1. ì»¨í…Œì´ë„ˆ ì„¤ì •: ê°€ë¡œ ë‚˜ì—´ ë° ìë™ ì¤„ ë°”ê¿ˆ (ì´ì „ê³¼ ë™ì¼) */
        .search-history-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px 0;
        }

        /* 2. ê°œë³„ ë‹‰ë„¤ì„ íƒœê·¸ ìŠ¤íƒ€ì¼ (ìˆ˜ì •): ì‘ì€ í¬ê¸°, ì„¸ë¡œ ê³ ì • */
        .nickname-tag {
            display: inline-flex;
            height: 28px;
            align-items: center;

            /* ë””ìì¸ ìŠ¤íƒ€ì¼ */
            background-color: #f0f0f0;
            border-radius: 14px;
            /* ì„œë²„ëª… ì¶”ê°€ë¡œ ì¢Œì¸¡ íŒ¨ë”©ì„ 10pxë¡œ ìœ ì§€ */
            padding: 0 5px 0 10px;
            font-size: 13px;
            color: #333;

            white-space: nowrap;
            margin-bottom: 5px;

            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ ì¶”ê°€ */
        }

        /* ë§ˆìš°ìŠ¤ ì˜¤ë²„(Hover) ì‹œ: í´ë¦­í•  ìˆ˜ ìˆìŒì„ ëª…í™•íˆ ë³´ì—¬ì¤Œ */
        .nickname-tag:hover {
            background-color: #e8e8e8;
            /* ë°°ê²½ìƒ‰ì„ ì•½ê°„ ì–´ë‘¡ê²Œ ë³€ê²½ */
            /* ë˜ëŠ” ë¯¸ë¬˜í•œ ê·¸ë¦¼ì íš¨ê³¼ ì¶”ê°€ */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* í´ë¦­ ì§í›„(Active) ì‹œ: í´ë¦­ë¨ì„ ê°•ì¡° */
        .nickname-tag:active {
            background-color: #ccc;
            /* í´ë¦­ ì‹œ ë” ì–´ë‘¡ê²Œ */
            transform: translateY(1px);
            /* ì‚´ì§ ëˆŒë¦¬ëŠ” ë“¯í•œ íš¨ê³¼ */
        }

        /* í‚¤ë³´ë“œ í¬ì»¤ìŠ¤ ì‹œ: í‚¤ë³´ë“œ ì ‘ê·¼ì„± ì‚¬ìš©ìì—ê²Œë„ ì‹œê°ì  íŒíŠ¸ ì œê³µ */
        .nickname-tag:focus {
            /* ê¸°ë³¸ ë¸Œë¼ìš°ì € ì•„ì›ƒë¼ì¸ ì œê±° (ì„ íƒ ì‚¬í•­) */
            outline: none;
            /* ëª…í™•í•œ í¬ì»¤ìŠ¤ í‘œì‹œ (ì˜ˆ: íŒŒë€ìƒ‰ í…Œë‘ë¦¬) */
            border: 1px solid #007bff;
        }

        /* 3. ì„œë²„ ì´ë¦„ ìŠ¤íƒ€ì¼ (ìƒˆë¡œ ì¶”ê°€) */
        .server-name {
            /* ë‹‰ë„¤ì„ë³´ë‹¤ ì‘ê²Œ í‘œì‹œí•˜ì—¬ ëœ ê°•ì¡° */
            font-size: 11px;
            color: #888;
            /* íšŒìƒ‰ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ë°°ê²½ì²˜ëŸ¼ ë³´ì´ê²Œ */
            font-weight: normal;

            /* ì„œë²„ ì´ë¦„ê³¼ ë‹‰ë„¤ì„ì„ êµ¬ë¶„í•˜ëŠ” ê²½ê³„ì„  */
            padding-right: 5px;
            margin-right: 5px;
            border-right: 1px solid #ccc;
            /* ì–‡ì€ ì„¸ë¡œì„  ì¶”ê°€ */

            /* ì„¸ë¡œì„  ë†’ì´ë¥¼ ë§ì¶”ê¸° ìœ„í•´ display ì„¤ì • */
            display: inline-block;
        }

        /* 4. ë‹‰ë„¤ì„ í…ìŠ¤íŠ¸ (ìˆ˜ì •) */
        .nickname-text {
            /* ì„œë²„ ì´ë¦„ì´ íŒ¨ë”©ì„ ì œê³µí•˜ë¯€ë¡œ, margin-rightëŠ” ë²„íŠ¼ê³¼ì˜ ê°„ê²©ë§Œ ë‚¨ê¹€ */
            font-weight: bold;
            /* ë‹‰ë„¤ì„ì„ ê°•ì¡° */
            margin-right: 5px;
        }

        /* 5. ì‚­ì œ ë²„íŠ¼ (x ë²„íŠ¼): (ì´ì „ê³¼ ë™ì¼) */
        .remove-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background-color: #ccc;
            color: white;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s;
        }

        .remove-btn:hover {
            background-color: #e00;
        }

        .custom-select {
            /* 1. ê¸°ë³¸ ë¸Œë¼ìš°ì € ìŠ¤íƒ€ì¼ ì œê±° */
            -webkit-appearance: none;
            /* Chrome, Safari */
            -moz-appearance: none;
            /* Firefox */
            appearance: none;
            /* í‘œì¤€ ì†ì„± */

            /* IE 10/11ì˜ ê¸°ë³¸ X ë²„íŠ¼ ìˆ¨ê¸°ê¸° (í•„ìš”í•˜ë‹¤ë©´) */
            /* IEëŠ” í‘œì¤€ appearance: none;ìœ¼ë¡œëŠ” ì™„ë²½íˆ ì œê±°ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. */
            /* select::-ms-expand { display: none; } */

            /* 2. í¬ê¸° ë° íŒ¨ë”© ì„¤ì • */
            padding: 8px 30px 8px 10px;
            /* ì˜¤ë¥¸ìª½ íŒ¨ë”©ì„ ë„“í˜€ ì»¤ìŠ¤í…€ í™”ì‚´í‘œ ê³µê°„ í™•ë³´ */
            font-size: 16px;
            line-height: 1.5;
            height: 40px;
            /* ë†’ì´ ê³ ì • */

            /* 3. ë””ìì¸ */
            background-color: #f8f8f8;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 4px;
            /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            /* ì€ì€í•œ ê·¸ë¦¼ì */

            /* í¬ì»¤ìŠ¤ ì‹œ ìŠ¤íƒ€ì¼ */
            transition: border-color 0.2s, box-shadow 0.2s;

            /* 5. ì»¤ìŠ¤í…€ í™”ì‚´í‘œ ì¶”ê°€ */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='none' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3E%3C/svg%3E");

            background-repeat: no-repeat;
            /* í™”ì‚´í‘œ ìœ„ì¹˜ ì¡°ì • (ì˜¤ë¥¸ìª½ì—ì„œ 10px, ì¤‘ì•™ ìˆ˜ì§) */
            background-position: right 10px center;
            background-size: 12px;
            /* í™”ì‚´í‘œ í¬ê¸° */

            /* (ì„ íƒ ì‚¬í•­) IE 10/11ì˜ í™”ì‚´í‘œ ì œê±° */
            /* select::-ms-expand { display: none; } */
        }

        .custom-select:focus {
            border-color: #007bff;
            /* í¬ì»¤ìŠ¤ ì‹œ íŒŒë€ìƒ‰ í…Œë‘ë¦¬ */
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            outline: none;
            /* ê¸°ë³¸ í¬ì»¤ìŠ¤ ì•„ì›ƒë¼ì¸ ì œê±° */
        }

        /* 4. Option ìš”ì†Œ ìŠ¤íƒ€ì¼ë§ (ì œí•œì ) */
        /* option ìš”ì†Œ ìì²´ëŠ” ë¸Œë¼ìš°ì €ê°€ ì œê³µí•˜ëŠ” ë“œë¡­ë‹¤ìš´ ëª©ë¡ì—ì„œ ë Œë”ë§ë˜ë¯€ë¡œ, 
   CSS ìŠ¤íƒ€ì¼ë§ì´ ë§¤ìš° ì œí•œì ì…ë‹ˆë‹¤ (ì£¼ë¡œ ìƒ‰ìƒ/ë°°ê²½ìƒ‰ ì •ë„ë§Œ ê°€ëŠ¥). */
        .custom-select option {
            background-color: white;
            color: #333;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>ë˜íŒŒ ë“í…œ ìœ íš¨ì„± ê²€ì‚¬ê¸°</h1>
        <div id="search-history-container" class="search-history-container">
            <div class="nickname-tag">
                <span class="server-name"> </span>
                <span class="nickname-text"> </span>
                <button class="remove-btn">x</button>
            </div>
        </div>
        <div class="input-area">
            <select id="serverSelect" onchange="saveSelectedServerId(this.value)" class="custom-select">
            </select>
            <input type="text" id="characterNameInput" placeholder="ìºë¦­í„°ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button id="searchButton" onclick="startSearch()">ì¡°íšŒ</button>
        </div>

        <div id="rarityFilters" style="margin-top: 15px;">
            <label>
                <input type="checkbox" id="filterTaecho" value="íƒœì´ˆ" onchange="filterTimeline()" checked> íƒœì´ˆ
            </label>
            <label>
                <input type="checkbox" id="filterEpic" value="ì—í”½" onchange="filterTimeline()" checked> ì—í”½
            </label>
            <label>
                <input type="checkbox" id="filterLegendary" value="ë ˆì „ë”ë¦¬" onchange="filterTimeline()" checked> ë ˆì „ë”ë¦¬
            </label>
        </div>

        <p id="totalRowCount" style="font-weight: bold; margin: 10px 0;">ì´ íƒ€ì„ë¼ì¸ ìˆ˜: 0</p>

        <div id="infoNotice"
            style="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; background: url('https://img-api.neople.co.kr/df/servers/cain/characters/4ecd3f9eea4b6dd87044a9d9323efd20?zoom=1') no-repeat center; color: #333; border-radius: 4px;">
            <strong>âœ… ìœ íš¨ í™•ë¥  ê³„ì‚° ì•ˆë‚´</strong>
            <p style="margin-top: 5px; margin-bottom: 0; font-size: 0.95em;">
            <ul>
                <li>ì´ í‘œëŠ” <b>ë¬´ê¸°</b> ë° <b>ê³ ìœ ë¥¼ ì œì™¸í•œ</b> íƒ€ì„ë¼ì¸ì„ ëª¨ë‘ ë³´ì—¬ì¤ë‹ˆë‹¤. <br /></li>
                <li>í•­ì•„ë¦¬, ì—…ê·¸ë ˆì´ë“œ, ì´ˆì›” ë“±ì€ í‘œì—ì„œ <b>ì œì™¸</b>ì§€ë§Œ í™•ë¥  ê³„ì‚°ì— í¬í•¨ì…ë‹ˆë‹¤.<br /></li>
                <li>'ìœ íš¨ í™•ë¥ 'ì€ ì•„ì´í…œì„ íšë“í•  <b>ë‹¹ì‹œ</b> ê¸°ì¤€ìœ¼ë¡œ ê·¸ ì„¸íŠ¸ì˜ ìœ íš¨ <b>ë¶€ìœ„</b> í™•ë¥ ì…ë‹ˆë‹¤. <br /></li>
                <li>ìš´ì€ ë¨¹ì—ˆì„ ë•Œì˜ ê²°ê³¼ìš´ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ë§ê±°ë‚˜ ì ê²Œ ëœ¬ë‹¤ëŠ” ì˜ë¯¸ê°€ ì•„ë‹™ë‹ˆë‹¤. <br /></li>
            </ul>
            </p>
        </div>

        <div id="status"></div>
        <table class="results-table">
            <thead>
                <tr>
                    <th>íšë“ ì‹œê°„</th>
                    <th>ì•„ì´í…œëª…</th>
                    <th>ë“±ê¸‰</th>
                    <th>ì„¸íŠ¸</th>
                    <th>ë¶€ìœ„</th>
                    <th>ìœ íš¨ í™•ë¥ </th>
                    <th>ìœ íš¨ ì—¬ë¶€</th>
                    <th>ìš´</th>
                </tr>
            </thead>
            <tbody id="resultsContainer">
            </tbody>
        </table>
    </div>

    <script>

        // ì œê³µëœ ì„œë²„ ë°ì´í„°
        const serverData = [
            { "serverId": "cain", "serverName": "ì¹´ì¸" },
            { "serverId": "diregie", "serverName": "ë””ë ˆì§€ì—" },
            { "serverId": "siroco", "serverName": "ì‹œë¡œì½”" },
            { "serverId": "prey", "serverName": "í”„ë ˆì´" },
            { "serverId": "casillas", "serverName": "ì¹´ì‹œì•¼ìŠ¤" },
            { "serverId": "hilder", "serverName": "íë”" },
            { "serverId": "anton", "serverName": "ì•ˆí†¤" },
            { "serverId": "bakal", "serverName": "ë°”ì¹¼" }
        ];

        // ğŸš¨ ëª¨ë“  íƒ€ì„ë¼ì¸ ë°ì´í„°ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜ ğŸš¨
        let allTimelinePages = [];
        let filteredTimelinePages = [];

        let chanceSeqTimeline = [];

        // ì „ì—­ ìºì‹œ ê°ì²´: ì•„ì´í…œ IDë¥¼ í‚¤(Key)ë¡œ, ì•„ì´í…œ ìƒì„¸ ì •ë³´ë¥¼ ê°’(Value)ìœ¼ë¡œ ì €ì¥
        const itemDetailsCache = {};

        // ğŸš¨ ì•„ì´í…œ íšë“ ì‹œì ê¹Œì§€ì˜ ì„¸íŠ¸ ë¶€ìœ„ ì ìœ  ìƒíƒœë¥¼ ì¶”ì í•˜ëŠ” ê°ì²´
        // Key: "ì„¸íŠ¸ì´ë¦„-í¬ê·€ë„" (ì˜ˆ: "ì„¸ë Œë””í”¼í‹° ì„¸íŠ¸-ì—í”½")
        // Value: Set ê°ì²´ë¡œ, ì´ë¯¸ íšë“í•œ ìŠ¬ë¡¯ ë¶€ìœ„ ì´ë¦„ë“¤ì„ ì €ì¥í•©ë‹ˆë‹¤.
        let setSlotTracker = {};

        // ğŸš¨ í¬ê·€ë„ ìˆœìœ„ ì •ì˜ (ë†’ì„ìˆ˜ë¡ ë‚®ì€ ìˆœìœ„ ê°’) ğŸš¨
        // ë¹„êµë¥¼ ìœ„í•´ ìˆœìœ„ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
        const RARITY_RANK = {
            'íƒœì´ˆ': 1,
            'ì—í”½': 2,
            'ë ˆì „ë”ë¦¬': 3
            // ë¬´ê¸°ëŠ” ì œì™¸, ë‚˜ë¨¸ì§€ í¬ê·€ë„ëŠ” VALID_RARITIESì—ì„œ ì œì™¸
        };

        // ì „ì²´ ì„¸íŠ¸ ë¶€ìœ„ ìˆ˜ (ë¬´ê¸° ì œì™¸ 11ê°œ)
        const TOTAL_SET_SLOTS = 11;
        // ìœ íš¨ í¬ê·€ë„ ëª©ë¡
        const VALID_RARITIES = ['íƒœì´ˆ', 'ì—í”½', 'ë ˆì „ë”ë¦¬'];

        // ğŸš¨ íƒœì´ˆ ì•„ì´í…œì˜ ì‹¤ì œ ì„¸íŠ¸ ë¶€ìœ„ (ì•¡ì„¸ì„œë¦¬ 3ì¢…) ğŸš¨
        const TAECHO_SLOTS = ['íŒ”ì°Œ', 'ëª©ê±¸ì´', 'ë°˜ì§€'];
        const MAX_TAECHO_SLOTS = TAECHO_SLOTS.length; // 3

        const VALID_SLOTS = ['ìƒì˜', 'ë¨¸ë¦¬ì–´ê¹¨', 'í•˜ì˜', 'ë²¨íŠ¸', 'ì‹ ë°œ', 'íŒ”ì°Œ', 'ëª©ê±¸ì´', 'ë°˜ì§€', 'ë³´ì¡°ì¥ë¹„', 'ë§ˆë²•ì„', 'ê·€ê±¸ì´'];

        const VALID_CODES = [505, 507, 513];

        // --- ì„¤ì • ë° ìƒìˆ˜ ---
        // *** í”„ë¡ì‹œ ì„œë²„ì˜ ê¸°ë³¸ ê²½ë¡œë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ***
        // Vercelì— ë°°í¬ëœ ê²½ìš°, /api/proxyëŠ” api/proxy.js ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
        const PROXY_BASE_URL = "/api/proxy/df"; // Neople APIì˜ /df ì´ì „ ê²½ë¡œë¥¼ í”„ë¡ì‹œë¡œ ì§€ì •

        let SERVER_ID = "cain";

        // ì•„ì´í…œ ë“±ê¸‰ ìš°ì„ ìˆœìœ„ (ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ)
        const RARITY_ORDER = {
            "íƒœì´ˆ": 3,
            "ì—í”½": 2,
            "ë ˆì „ë”ë¦¬": 1
        };

        // --- DOM ìš”ì†Œ ---
        const charInput = document.getElementById('characterNameInput');
        const searchBtn = document.getElementById('searchButton');
        const statusEl = document.getElementById('status');
        const resultsEl = document.getElementById('resultsContainer');

        // DB ì—°ê²° ê°ì²´ë¥¼ ì €ì¥í•  ë³€ìˆ˜ (ì „ì—­ì ìœ¼ë¡œ ì‚¬ìš©)
        let db;
        const DB_NAME = 'dnfTimeline';
        const DB_VERSION = 1;
        const CHARACTER_STORE = 'characters';
        const ITEM_STORE = 'items';
        const TIMELINE_STORE = 'timelines';
        const DEFAULT_ID = 1;

        /**
 * ìºë¦­í„°ëª… ì…ë ¥ì°½ì—ì„œ Enter í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ startSearch() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
 * @param {Event} event - í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ê°ì²´
 */
        function handleEnterKey(event) {
            // Enter í‚¤ì˜ keyCodeëŠ” 13ì…ë‹ˆë‹¤.
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault(); // ê¸°ë³¸ Enter ë™ì‘(í¼ ì œì¶œ ë“±) ë°©ì§€
                startSearch();         // ì¡°íšŒ ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œ
            }
        }

        // --- API í˜¸ì¶œ í•¨ìˆ˜ ---

        // 1. ìºë¦­í„° ID ì¡°íšŒ
        function getCharacterId(characterName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([CHARACTER_STORE], 'readwrite');
                const store = transaction.objectStore(CHARACTER_STORE);
                const getRequest = store.get(DEFAULT_ID);
                getRequest.onsuccess = (event) => {
                    const characterObject = event.target.result;

                    if (characterObject) {
                        const serverObject = characterObject[SERVER_ID];
                        if (!serverObject) {
                            store.put({ ...characterObject, [SERVER_ID]: {} }, DEFAULT_ID);
                        } else {
                            const characterId = serverObject[characterName];
                            if (!characterId) {
                                resolve(getCharacterIdApi());
                            } else {
                                resolve(characterId);
                            }
                        }
                    } else {
                        console.log(`charactersë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                        resolve(getCharacterIdApi());
                    }
                };

                getRequest.onerror = (event) => {
                    console.error("ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:", event.target.error);
                    resolve(getCharacterIdApi());
                };


                function getCharacterIdApi() {
                    return new Promise((resolve, reject) => {
                        const url = `${PROXY_BASE_URL}/servers/${SERVER_ID}/characters?characterName=${encodeURIComponent(characterName)}`;
                        fetch(url).then((response) => {
                            if (!response.ok) reject("ìºë¦­í„° ID ì¡°íšŒ ì‹¤íŒ¨");
                            return response.json();
                        }).then((data) => {
                            if (!data.rows || data.rows.length === 0) reject("ìºë¦­í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                            const character = data.rows[0];
                            const transaction = db.transaction([CHARACTER_STORE], 'readwrite');
                            const store = transaction.objectStore(CHARACTER_STORE);
                            const getReq = store.get(DEFAULT_ID);
                            getReq.onsuccess = (event) => {
                                const characterObject = event.target.result || {};
                                const serverObject = characterObject[SERVER_ID] || {};
                                const putReq = store.put({ ...characterObject, [SERVER_ID]: { ...serverObject, [character.characterName]: character.characterId } }, DEFAULT_ID);
                                putReq.onsuccess = (event) => {
                                    resolve(character.characterId);
                                };
                                putReq.onerror = (event) => {
                                    reject(`put character id error`, event.target.error);
                                }
                            }
                            getReq.onerror = (event) => {
                                reject(`get character id error`, event.target.error);
                            }
                        });
                    })
                }

            });
        }

        // 1.5. ìºë¦­í„° set ì¡°íšŒ
        async function getCharacterEquipment(characterId) {
            const url = `${PROXY_BASE_URL}/servers/${SERVER_ID}/characters/${characterId}/equip/equipment?`;
            const response = await fetch(url);
            if (!response.ok) throw new Error("ìºë¦­í„° ì¥ë¹„ ì¡°íšŒ ì‹¤íŒ¨");
            const data = await response.json();
            if (!data.equipment || data.equipment.length === 0) throw new Error("ìºë¦­í„° ì¥ë¹„ ì¡°íšŒë¥¼ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            return data.equipment.find(e => e.setItemName)?.setItemName;
        }

        // 2. íƒ€ì„ë¼ì¸ ì¡°íšŒ (ì›”ë³„ë¡œ ë°˜ë³µ í˜¸ì¶œ)
        async function getAllTimelinePages(characterId) {
            let allTimelineRows = [];
            let currentMonthStart = new Date('2025-01-01');
            const today = new Date();

            while (currentMonthStart < today) {
                // ë‹¤ìŒ ë‹¬ 1ì¼ ê³„ì‚°
                let nextMonthStart = new Date(currentMonthStart.getFullYear(), currentMonthStart.getMonth() + 1, 1);
                if (nextMonthStart > today) {
                    nextMonthStart = today;
                }

                // ë‚ ì§œ í¬ë§·íŒ… (YYYYMMDD)
                const startDateStr = formatDate(currentMonthStart);
                const endDateStr = nextMonthStart === today ? formatDate(nextMonthStart) + formatToApiTime(nextMonthStart) : formatDate(nextMonthStart);

                statusEl.textContent = `${currentMonthStart.getFullYear()}ë…„ ${currentMonthStart.getMonth() + 1}ì›” íƒ€ì„ë¼ì¸ ì¡°íšŒ ì¤‘...`;

                const url = `${PROXY_BASE_URL}/servers/${SERVER_ID}/characters/${characterId}/timeline?limit=100&code=505,507,513,504,511,516,514&startDate=${startDateStr}&endDate=${endDateStr}`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.timeline && data.timeline.rows) {
                        allTimelineRows.push(...data.timeline.rows);
                    }
                    if (data.timeline.next) {
                        const urlNext = `${PROXY_BASE_URL}/servers/${SERVER_ID}/characters/${characterId}/timeline?next=${data.timeline.next}`;
                        const responseNext = await fetch(urlNext);
                        const dataNext = await responseNext.json();
                        if (dataNext.timeline && dataNext.timeline.rows) {
                            allTimelineRows.push(...dataNext.timeline.rows);
                        }
                    }
                } catch (e) {
                    console.error(`${startDateStr} íƒ€ì„ë¼ì¸ ì¡°íšŒ ì‹¤íŒ¨:`, e);
                    // í•œë‘ ë‹¬ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
                }

                // ë‹¤ìŒ ë‹¬ë¡œ ì´ë™
                currentMonthStart = nextMonthStart;
            }

            const allItemIds = [];
            allTimelineRows.forEach(row => {
                if (row.data && row.data.itemId) {
                    // itemIdê°€ ì‰¼í‘œë¡œ ë¶„ë¦¬ë˜ì–´ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ëª¨ë‘ ì¶”ì¶œ
                    const ids = row.data.itemId.split(',').map(id => id.trim()).filter(id => id.length > 0);
                    allItemIds.push(...ids);
                }
            });

            // ìˆ˜ì§‘ëœ ëª¨ë“  ì•„ì´í…œ IDì— ëŒ€í•´ ë‹¤ì¤‘ ì¡°íšŒ í•¨ìˆ˜ í˜¸ì¶œ
            await getTimelineItemDetails(allItemIds);
            return allTimelineRows;
        }

        // âš ï¸ ì¶”ê°€: APIê°€ ìš”êµ¬í•˜ëŠ” hhmm í˜•ì‹ìœ¼ë¡œ ì‹œê°„ì„ í¬ë§·í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function formatToApiTime(date) {
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            return `T${hh}${mm}`;
        }

        // ê¸°ì¡´: getItemDetails(itemId)ë¥¼ ëŒ€ì²´í•˜ëŠ” í•¨ìˆ˜
        // íƒ€ì„ë¼ì¸ì—ì„œ í•„ìš”í•œ ëª¨ë“  ì•„ì´í…œ ID ëª©ë¡ì„ ë°›ì•„ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ìºì‹œì— ì €ì¥í•©ë‹ˆë‹¤.
        async function getTimelineItemDetails(allItemIds) {
            const uniqueItemIds = Array.from(new Set(allItemIds));
            const itemIdsToFetch = [];

            // 1. ìºì‹œ í™•ì¸ ë° ì¡°íšŒí•  ëª©ë¡ ë¶„ë¥˜
            for (const itemId of uniqueItemIds) {
                if (!itemDetailsCache[itemId]) {
                    itemIdsToFetch.push(itemId); // ìºì‹œì— ì—†ëŠ” ì•„ì´í…œë§Œ ì¡°íšŒ ëª©ë¡ì— ì¶”ê°€
                }
            }

            if (itemIdsToFetch.length === 0) {
                console.log("[Multi-Fetch] All items found in cache.");
                return; // ì¡°íšŒí•  ì•„ì´í…œì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
            }

            console.log(`[Multi-Fetch] Need to fetch ${itemIdsToFetch.length} items.`);

            // 2. ì•„ì´í…œ IDë¥¼ ìµœëŒ€ 15ê°œì”© ë¬¶ì–´ API í˜¸ì¶œ
            const CHUNK_SIZE = 15;
            const fetchPromises = [];

            for (let i = 0; i < itemIdsToFetch.length; i += CHUNK_SIZE) {
                const chunk = itemIdsToFetch.slice(i, i + CHUNK_SIZE);
                const itemIdsParam = chunk.join(','); // ì•„ì´í…œ IDë“¤ì„ ì½¤ë§ˆë¡œ ì—°ê²°

                // ë‹¤ì¤‘ ì¡°íšŒ API URL
                const url = `${PROXY_BASE_URL}/multi/items?itemIds=${encodeURIComponent(itemIdsParam)}`;

                // í”„ë¡ì‹œ ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ê³  Promiseë¥¼ ë°°ì—´ì— ì €ì¥
                fetchPromises.push(
                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`ë‹¤ì¤‘ ì•„ì´í…œ ì¡°íšŒ ì‹¤íŒ¨: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            // 3. ì‘ë‹µ ë°ì´í„°ë¥¼ íŒŒì‹±í•˜ì—¬ ìºì‹œì— ì €ì¥
                            if (data.rows) {
                                for (const itemData of data.rows) {
                                    const itemId = itemData.itemId;
                                    itemDetailsCache[itemId] = itemData; // ìºì‹œ ì—…ë°ì´íŠ¸
                                }
                            }
                        })
                        .catch(error => {
                            console.error(`ì•„ì´í…œ ë¬¶ìŒ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                            // ì˜¤ë¥˜ ë°œìƒ ì‹œ í•´ë‹¹ ì•„ì´í…œë“¤ì˜ ìºì‹œ í•­ëª©ì€ undefinedë¡œ ë‚¨ìŠµë‹ˆë‹¤.
                        })
                );
            }

            // 4. ëª¨ë“  API í˜¸ì¶œì´ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
            await Promise.all(fetchPromises);
        }

        // 3. ì•„ì´í…œ ìƒì„¸ ì •ë³´ ì¡°íšŒ (ìºì‹œ ì‚¬ìš©)
        const itemDetailCache = new Map();
        async function getItemDetails(itemId) {
            if (itemDetailCache.has(itemId)) {
                return itemDetailCache.get(itemId);
            }

            const url = `${PROXY_BASE_URL}/items/${itemId}`;
            try {
                const response = await fetch(url);
                if (!response.ok) return null; // ì¡°íšŒ ì‹¤íŒ¨ ì‹œ null ë°˜í™˜
                const data = await response.json();
                itemDetailCache.set(itemId, data); // ìºì‹œì— ì €ì¥
                return data;
            } catch (e) {
                console.error(`ì•„ì´í…œ(${itemId}) ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:`, e);
                return null;
            }
        }

        // --- ë©”ì¸ ë¡œì§ ---
        async function startSearch() {
            const characterName = charInput.value.trim();
            if (!characterName) {
                alert("ìºë¦­í„°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            // ì´ˆê¸°í™”
            searchBtn.disabled = true;
            charInput.readonly = true;
            statusEl.textContent = "ì¡°íšŒë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...";
            resultsEl.innerHTML = "";
            itemDetailCache.clear(); // ì•„ì´í…œ ìºì‹œ ì´ˆê¸°í™”

            try {
                // 1. ìºë¦­í„° ID ê°€ì ¸ì˜¤ê¸°
                statusEl.textContent = "ìºë¦­í„° ID ì¡°íšŒ ì¤‘...";
                const characterId = await getCharacterId(characterName);
                const el = document.getElementById('infoNotice');
                el.style.background = `url('https://img-api.neople.co.kr/df/servers/${SERVER_ID}/characters/${characterId}?zoom=1') no-repeat center`

                loadAndDisplayTags();
                resetGlobalData();

                // 2. ëª¨ë“  íƒ€ì„ë¼ì¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì›”ë³„)
                const [set, allTimelineRows] = await Promise.all([getCharacterEquipment(characterId), getAllTimelinePages(characterId)]);

                if (allTimelineRows.length === 0) {
                    statusEl.textContent = "ì¡°íšŒ ê¸°ê°„ ë‚´ ì•„ì´í…œ íšë“ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
                    searchBtn.disabled = false;
                    charInput.readonly = false;
                    return;
                }



                // 3. íƒ€ì„ë¼ì¸ ì²˜ë¦¬ (ì˜¤ë˜ëœ ìˆœìœ¼ë¡œ ì •ë ¬)
                statusEl.textContent = "íƒ€ì„ë¼ì¸ ì²˜ë¦¬ ì¤‘... (ì•„ì´í…œ ìƒì„¸ ì •ë³´ ì¡°íšŒ)";
                allTimelineRows.sort((a, b) => new Date(a.date) - new Date(b.date)); // íšë“ìˆœ(ì˜¤ë¦„ì°¨ìˆœ) ì •ë ¬

                const processedItems = [];
                const highestAcquiredRarity = {}; // Key: "ì„¸íŠ¸ëª…_ë¶€ìœ„ëª…", Value: ë“±ê¸‰ ì ìˆ˜(3, 2, 1)

                let processedCount = 0;
                for (const itemDrop of allTimelineRows) {
                    processedCount++;
                    statusEl.textContent = `íƒ€ì„ë¼ì¸ ì²˜ë¦¬ ì¤‘... (${processedCount}/${allTimelineRows.length})`;

                    const dropData = itemDrop.data;
                    const itemId = dropData.itemId;
                    const itemRarity = dropData.itemRarity;
                    const dropDate = itemDrop.date;
                    const code = itemDrop.code;

                    // 3-1. ì•„ì´í…œ ìƒì„¸ ì •ë³´ ì¡°íšŒ
                    const details = itemDetailsCache[itemId];

                    // 3-2. ìœ íš¨ì„± ê²€ì‚¬: 115ë ˆë²¨ì´ ì•„ë‹ˆê±°ë‚˜, ì„¸íŠ¸ ì•„ì´í…œì´ ì•„ë‹ˆë©´ ë¬´ì‹œ
                    if (!details || details.itemAvailableLevel !== 115 || !details.setItemName) {
                        continue;
                    }

                    const setItemName = details.setItemName;
                    const itemTypeDetail = details.itemTypeDetail;

                    if (!VALID_SLOTS.includes(itemTypeDetail)) continue;

                    // 3-3. ìœ íš¨ì„± ë¡œì§ ì‹¤í–‰
                    const itemKey = `${setItemName}_${itemTypeDetail}`;
                    const currentRarityScore = RARITY_ORDER[itemRarity] || 0;
                    const highestRarityScore = highestAcquiredRarity[itemKey] || 0;

                    let isValid = false;

                    // ğŸš¨ í¬ê·€ë„ë³„ ìŠ¤íƒ€ì¼ì„ ì €ì¥í•  ë³€ìˆ˜ ğŸš¨
                    let itemStyle = '';

                    // 1. ì•„ì´í…œ í¬ê·€ë„ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ê²°ì •
                    if (itemRarity === 'ë ˆì „ë”ë¦¬') {
                        itemStyle = 'color: rgb(239, 112, 0);';
                    } else if (itemRarity === 'ì—í”½') {
                        itemStyle = 'color: rgb(239, 169, 0);';
                    } else if (itemRarity === 'íƒœì´ˆ') {
                        // ê·¸ë¼ë°ì´ì…˜ì€ CSS backgroundë¡œ ì ìš©í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì´ë‚˜, 
                        // í…ìŠ¤íŠ¸ì—ë§Œ ì ìš©í•˜ë ¤ë©´ ì›¹í‚·(WebKit) ì†ì„±ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
                        // ì—¬ê¸°ì„œëŠ” í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì„¤ì •í•˜ê³ , ì…€ ë°°ê²½ì— ì ìš©í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬í•˜ê² ìŠµë‹ˆë‹¤.
                        itemStyle = 'color: #3057a6; font-weight: bold; background-image: linear-gradient(180deg, #55e95b, #3057a6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;';
                        // âš ï¸ ì£¼ì˜: ì›¹í‚·(Chrome, Safari) ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì •ìƒì ìœ¼ë¡œ í…ìŠ¤íŠ¸ ê·¸ë¼ë°ì´ì…˜ì´ ë³´ì…ë‹ˆë‹¤.
                    } else {
                        itemStyle = ''; // ê¸°íƒ€ í¬ê·€ë„ëŠ” ê¸°ë³¸ ìŠ¤íƒ€ì¼
                    }


                    let probabilityContent = '';
                    let styleClass = ''; // ìƒˆë¡œ ì¶”ê°€ëœ ìŠ¤íƒ€ì¼ ë³€ìˆ˜
                    let resultClass = 'result-normal';
                    let roundedProbability = 0;
                    let resultText = '';

                    // 2. ìŠ¬ë¡¯ ì¶”ì ê¸° êµ¬ì¡°: setSlotTracker[setName] = Map<Rarity, Set<SlotName>>
                    if (!setSlotTracker[setItemName]) {
                        setSlotTracker[setItemName] = {};
                    }
                    if (!setSlotTracker[setItemName][itemRarity]) {
                        setSlotTracker[setItemName][itemRarity] = new Set();
                    }

                    // 3. í˜„ì¬ í¬ê·€ë„ì˜ ìˆœìœ„ í™•ì¸
                    const targetRank = RARITY_RANK[itemRarity];
                    let filledSlotCount = 0;
                    const countedSlots = new Set(); // ì¤‘ë³µ ë¶€ìœ„ ì¹´ìš´íŠ¸ë¥¼ ë§‰ê¸° ìœ„í•œ Set

                    // 4. ì´ë¯¸ ì±„ì›Œì§„ ë¶€ìœ„ ì¹´ìš´íŠ¸ (ìˆœìœ„ê°€ ê°™ê±°ë‚˜ ë” ë†’ì€ í¬ê·€ë„ë§Œ ì¹´ìš´íŠ¸)
                    // 'ë” ë†’ì€ í¬ê·€ë„'ëŠ” ìˆœìœ„ ê°’ì´ 'ë” ë‚®ê±°ë‚˜ ê°™ì€' ê²½ìš°ì…ë‹ˆë‹¤.
                    for (const r in RARITY_RANK) {
                        if (RARITY_RANK[r] <= targetRank) {
                            if (setSlotTracker[setItemName][r]) {
                                setSlotTracker[setItemName][r].forEach(slot => {
                                    // ğŸš¨ íƒœì´ˆ ë“±ê¸‰ ì•„ì´í…œì¼ ê²½ìš°, ìŠ¬ë¡¯ì„ 3ê°œë¡œ ì œí•œ ğŸš¨
                                    if (itemRarity === 'íƒœì´ˆ' && !TAECHO_SLOTS.includes(slot)) {
                                        return; // íƒœì´ˆê°€ ì•„ë‹Œ ë¶€ìœ„ëŠ” ì¹´ìš´íŠ¸í•˜ì§€ ì•ŠìŒ
                                    }
                                    countedSlots.add(slot);
                                });
                            }
                        }
                    }
                    // 5. íƒœì´ˆ ì•„ì´í…œì˜ ê²½ìš°, ì¹´ìš´íŒ… ëœ ë¶€ìœ„ ì¤‘ ìµœëŒ€ 3ê°œë§Œ ìœ íš¨ ë¶€ìœ„ë¡œ ê°„ì£¼
                    if (itemRarity === 'íƒœì´ˆ') {
                        filledSlotCount = Math.min(countedSlots.size, MAX_TAECHO_SLOTS);
                    } else {
                        filledSlotCount = countedSlots.size;
                    }

                    // 5. í™•ë¥  ê³„ì‚°
                    if (filledSlotCount < TOTAL_SET_SLOTS) {
                        // ë‚¨ì€ ìœ íš¨ ë¶€ìœ„ ê°œìˆ˜: 11 - í˜„ì¬ íšë“í•œ ë¶€ìœ„ ê°œìˆ˜
                        let remainingValidSlots = TOTAL_SET_SLOTS - filledSlotCount;
                        let probability = (remainingValidSlots / TOTAL_SET_SLOTS) * 100;
                        if (itemRarity === 'íƒœì´ˆ') {
                            remainingValidSlots = MAX_TAECHO_SLOTS - filledSlotCount;
                            probability = (remainingValidSlots / MAX_TAECHO_SLOTS) * 100;
                        }

                        // ì†Œìˆ˜ì  ì²«ì§¸ ìë¦¬ì—ì„œ ë°˜ì˜¬ë¦¼
                        roundedProbability = Math.round(probability);
                        probabilityContent = `${roundedProbability}%`;

                        // ğŸš¨ í™•ë¥  êµ¬ê°„ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ê²°ì • ğŸš¨
                        if (roundedProbability <= 25) {
                            styleClass = 'prob-low';
                        } else if (roundedProbability <= 50) {
                            styleClass = 'prob-mid-low';
                        } else if (roundedProbability <= 75) {
                            styleClass = 'prob-mid-high';
                        } else { // 76% ~ 100%
                            styleClass = 'prob-high';
                        }
                    } else {
                        // ì´ë¯¸ 11ë¶€ìœ„ë¥¼ ë‹¤ ì±„ìš´ ê²½ìš°
                        probabilityContent = '0%';
                        styleClass = 'prob-low'; // 0%ëŠ” ê°€ì¥ ë‚®ì€ êµ¬ê°„ìœ¼ë¡œ ì„¤ì •
                    }

                    // 6. ìŠ¬ë¡¯ íŠ¸ë˜ì»¤ ì—…ë°ì´íŠ¸ (í™•ë¥  ê³„ì‚° í›„, í˜„ì¬ ì•„ì´í…œ ë¶€ìœ„ë¥¼ ì¶”ê°€)
                    // 7. ìŠ¬ë¡¯ íŠ¸ë˜ì»¤ ì—…ë°ì´íŠ¸
                    // ğŸš¨ íƒœì´ˆì¼ ê²½ìš°, íŠ¸ë˜ì»¤ì— ì¶”ê°€í•  ë•Œë„ 3ê°œ ë¶€ìœ„ë§Œ ì¶”ê°€í•˜ë„ë¡ ì œì•½ ğŸš¨
                    if (itemRarity === 'íƒœì´ˆ' && !TAECHO_SLOTS.includes(itemTypeDetail)) {
                        // íƒœì´ˆ ì•„ì´í…œì´ ì•„ë‹Œ ë¶€ìœ„ (ì˜ˆ: ë¬´ê¸°)ë¡œ ì˜ëª» ë“¤ì–´ì™”ë‹¤ë©´ íŠ¸ë˜ì»¤ì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                    } else {
                        setSlotTracker[setItemName][itemRarity].add(itemTypeDetail);
                    }

                    // í˜„ì¬ íšë“í•œ ì•„ì´í…œ ë“±ê¸‰ì´ ì´ì „ì— íšë“í•œ ìµœê³  ë“±ê¸‰ë³´ë‹¤ ë†’ì•„ì•¼ ìœ íš¨
                    if (currentRarityScore > highestRarityScore) {
                        isValid = true;
                        highestAcquiredRarity[itemKey] = currentRarityScore; // ìµœê³  ë“±ê¸‰ ê°±ì‹ 
                    }

                    if (roundedProbability <= 20 && isValid) {
                        resultClass = 'result-success-low-prob';
                        resultText = 'ìš´ë„ì‹¤ë ¥';
                    } else if (roundedProbability >= 80 && !isValid) {
                        resultClass = 'result-fail-high-prob';
                        resultText = 'ë‚˜ë§Œìš´ì—†ì–´';
                    } else if (itemRarity === 'íƒœì´ˆ' && !isValid) {
                        resultClass = 'result-fail-high-prob';
                        resultText = 'íƒœì´ˆì¤‘ë³µâ˜ ';
                    } else if (itemRarity === 'íƒœì´ˆ' && isValid && roundedProbability <= 34) {
                        resultClass = 'result-success-low-prob';
                        resultText = 'íƒœì´ˆ3ì…‹sex';
                    }

                    let setClass = '';
                    if (set === setItemName) {
                        setClass = 'highlight-set';
                    }


                    // ì•„ì´í…œ ì—°ì† ìš´ ì„¤ì •
                    if (chanceSeqTimeline?.length > 0) {
                        const seqLength = chanceSeqTimeline.length;
                        const last = chanceSeqTimeline[seqLength - 1];

                        if (isValidCode(code) && isValid !== last.isValid) {
                            const tempSeqTimeline = [...chanceSeqTimeline];

                            // ì—°ì† ì •ë³´ ì´ˆê¸°í™”
                            chanceSeqTimeline = [];

                            // ë§ˆì§€ë§‰ ì•„ì´í…œì— ê²°ê³¼ ì¶”ê°€
                            if (seqLength >= 3) {
                                let validSeqLength = 0;
                                for (let i = seqLength; i >= 3; i--) {
                                    const slicedList = tempSeqTimeline.slice(-i);
                                    const slicedSeqLength = slicedList.length;
                                    const chanceSum = slicedList.reduce((acc, cur) => acc + cur.probability, 0);
                                    if (chanceSum <= 33 * slicedSeqLength && last.isValid) {
                                        processedItems[processedItems.length - 1].resultClass = 'result-success-low-prob';
                                        processedItems[processedItems.length - 1].resultText = 'ğŸ’¯'.repeat(slicedSeqLength);
                                        break;
                                    } else if (chanceSum >= 66 * slicedSeqLength && !last.isValid) {
                                        processedItems[processedItems.length - 1].resultClass = 'result-fail-high-prob';
                                        processedItems[processedItems.length - 1].resultText = 'â˜ '.repeat(slicedSeqLength);
                                        break;
                                    }
                                }

                            }


                        }
                    }
                    if (isValidCode(code)) {
                        chanceSeqTimeline.push({
                            isValid: isValid,
                            probability: roundedProbability,
                            itemName: dropData.itemName
                        });
                    }




                    processedItems.push({
                        date: dropDate,
                        itemName: dropData.itemName,
                        rarity: itemRarity,
                        setName: setItemName,
                        slot: itemTypeDetail,
                        isValid: isValid,
                        probabilityContent: probabilityContent,
                        styleClass: styleClass,
                        style: itemStyle,
                        resultClass: resultClass,
                        resultText: resultText,
                        setClass: setClass,
                        code: code
                    });
                }


                // ğŸš¨ ì „ì—­ ë³€ìˆ˜ì— ì „ì²´ ë°ì´í„° ì €ì¥ ğŸš¨
                allTimelinePages = processedItems;
                filterTimeline();
                // 4. ê²°ê³¼ ì¶œë ¥
                displayResults();

            } catch (error) {
                console.error(error);
                statusEl.textContent = `ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
            } finally {
                searchBtn.disabled = false;
                charInput.readonly = false;
                if (!statusEl.textContent.startsWith("ì˜¤ë¥˜")) {
                    statusEl.textContent = "ì¡°íšŒ ì™„ë£Œ!";
                }
            }
        }

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

        // ê²°ê³¼ í…Œì´ë¸”ì— í‘œì‹œ
        function displayResults() {
            const items = filteredTimelinePages;
            // ìµœì‹ ìˆœ(ë‚´ë¦¼ì°¨ìˆœ)ìœ¼ë¡œ ì •ë ¬í•˜ì—¬ í‘œì‹œ
            // items.sort((a, b) => new Date(b.date) - new Date(a.date));
            if (items[0].date < items[items.length - 1].date) { items.reverse(); }

            if (items.length === 0) {
                resultsEl.innerHTML = '<tr><td colspan="6">í‘œì‹œí•  115ë ˆë²¨ ì„¸íŠ¸ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            let html = "";
            for (const item of items) {
                const validityClass = item.isValid ? 'valid-true' : 'valid-false';
                const validityText = item.isValid ? 'ìœ íš¨' : 'ì¤‘ë³µ';

                html += `
                    <tr class="${item.setClass}">
                        <td>${item.date}</td>
                        <td style="${item.style}">${item.itemName}</td>
                        <td style="${item.style}">${item.rarity}</td>
                        <td>${item.setName}</td>
                        <td>${item.slot}</td>
                        <td class="probability-cell ${item.styleClass}">${item.probabilityContent}</td>
                        <td class="${validityClass}">${validityText}</td>
                        <td class="${item.resultClass}">${item.resultText}</td>
                    </tr>
                `;
            }
            resultsEl.innerHTML = html;

            const rowCountElement = document.getElementById('totalRowCount'); // ğŸš¨ ìƒˆë¡œìš´ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ğŸš¨
            // 3. ì´ í–‰ ìˆ˜ ì—…ë°ì´íŠ¸
            if (rowCountElement) {
                rowCountElement.textContent = `ì´ íƒ€ì„ë¼ì¸ ìˆ˜: ${items.length}`;
            }

        }

        // ë‚ ì§œë¥¼ 'YYYYMMDD' í˜•ì‹ì˜ ë¬¸ìì—´ë¡œ ë³€í™˜
        function formatDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}${month}${day}`;
        }

        /**
 * ì²´í¬ë°•ìŠ¤ ìƒíƒœì— ë”°ë¼ íƒ€ì„ë¼ì¸ ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ê³  ë…¸ì¶œí•©ë‹ˆë‹¤.
 */
        function filterTimeline() {
            if (!allTimelinePages || allTimelinePages.length === 0) {
                return; // ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í…Œì´ë¸”ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¢…ë£Œ
            }

            // 1. ì²´í¬ëœ ë“±ê¸‰(Rarities) í™•ì¸
            const checkedRarities = [];
            if (document.getElementById('filterTaecho')?.checked) checkedRarities.push('íƒœì´ˆ');
            if (document.getElementById('filterEpic')?.checked) checkedRarities.push('ì—í”½');
            if (document.getElementById('filterLegendary')?.checked) checkedRarities.push('ë ˆì „ë”ë¦¬');

            // ì²´í¬ëœ ë“±ê¸‰ì´ ì—†ìœ¼ë©´ ëª¨ë“  ë°ì´í„°ë¥¼ ë…¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            if (checkedRarities.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">ì„ íƒëœ ì•„ì´í…œ ë“±ê¸‰ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            // 2. ì „ì²´ ë°ì´í„°ë¥¼ ìˆœíšŒí•˜ë©° í•„í„°ë§
            filteredTimelinePages = allTimelinePages.filter(row => checkedRarities.includes(row.rarity)).filter(row => isValidCode(row.code));

            displayResults();
        }

        function resetGlobalData() {
            allTimelinePages = [];
            filteredTimelinePages = [];

            // ğŸš¨ ì•„ì´í…œ íšë“ ì‹œì ê¹Œì§€ì˜ ì„¸íŠ¸ ë¶€ìœ„ ì ìœ  ìƒíƒœë¥¼ ì¶”ì í•˜ëŠ” ê°ì²´
            // Key: "ì„¸íŠ¸ì´ë¦„-í¬ê·€ë„" (ì˜ˆ: "ì„¸ë Œë””í”¼í‹° ì„¸íŠ¸-ì—í”½")
            // Value: Set ê°ì²´ë¡œ, ì´ë¯¸ íšë“í•œ ìŠ¬ë¡¯ ë¶€ìœ„ ì´ë¦„ë“¤ì„ ì €ì¥í•©ë‹ˆë‹¤.
            setSlotTracker = {};

            chanceSeqTimeline = [];
        }

        // ------------------------------------------------------------------
        // ğŸš¨ DOM ë¡œë“œ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ğŸš¨
        document.addEventListener('DOMContentLoaded', (event) => {
            const inputElement = document.getElementById('characterNameInput');

            // input ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            if (inputElement) {
                inputElement.addEventListener('keydown', handleEnterKey);
            }
        });

        // 1. ë“œë¡­ë‹¤ìš´ ì˜µì…˜ì„ ìƒì„±í•˜ê³  ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
        function populateServerOptions() {
            const selectElement = document.getElementById('serverSelect');

            serverData.forEach((server, index) => {
                const option = document.createElement('option');
                option.value = server.serverId; // optionì˜ valueì— serverId ì €ì¥
                option.textContent = server.serverName; // ì‚¬ìš©ìì—ê²Œ ë³´ì´ëŠ” í…ìŠ¤íŠ¸

                // ì²« ë²ˆì§¸ í•­ëª©(index === 0)ì„ ê¸°ë³¸ ì„ íƒê°’ìœ¼ë¡œ ì§€ì •
                if (index === 0) {
                    option.selected = true;
                }

                selectElement.appendChild(option);
            });
        }

        // 2. ì„ íƒëœ ê°’ì„ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥í•˜ê³  í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function saveSelectedServerId(serverId) {
            // ì „ì—­ ë³€ìˆ˜ì— ê°’ ì €ì¥
            SERVER_ID = serverId;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜µì…˜ ìƒì„± í•¨ìˆ˜ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', populateServerOptions);

        function isValidCode(code) {
            return VALID_CODES.includes(code);
        }







        /**
         * 1. DB ì—°ê²° ì‹œë„ (ìµœì´ˆ 1íšŒ ì‹¤í–‰)
         */
        function openDatabase() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            // DB ë²„ì „ ì—…ê·¸ë ˆì´ë“œ ë˜ëŠ” ìµœì´ˆ ìƒì„± ì‹œ ì‹¤í–‰ë¨
            request.onupgradeneeded = (event) => {
                const db = event.target.result;

                // ê°ì²´ ì €ì¥ì†Œ(í…Œì´ë¸”) ìƒì„±
                if (!db.objectStoreNames.contains(CHARACTER_STORE)) {
                    db.createObjectStore(CHARACTER_STORE, { autoIncrement: true });
                }
                if (!db.objectStoreNames.contains(ITEM_STORE)) {
                    db.createObjectStore(ITEM_STORE, { autoIncrement: true });
                }
                if (!db.objectStoreNames.contains(TIMELINE_STORE)) {
                    db.createObjectStore(TIMELINE_STORE, { autoIncrement: true });
                }
                console.log('ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ì„¤ì • ì™„ë£Œ.');
            };

            // DB ì—°ê²° ì„±ê³µ ì‹œ ì‹¤í–‰ë¨
            request.onsuccess = (event) => {
                db = event.target.result; // ì „ì—­ ë³€ìˆ˜ì— DB ê°ì²´ ì €ì¥
                console.log('IndexedDB ì—°ê²° ì„±ê³µ.');

                // â˜…â˜…â˜… ì—°ê²° ì„±ê³µ í›„ ë°ì´í„° ë¡œë“œ ì‹œì‘ â˜…â˜…â˜…
                loadAndDisplayTags();
            };

            // DB ì—°ê²° ì‹¤íŒ¨ ì‹œ ì‹¤í–‰ë¨
            request.onerror = (event) => {
                console.error('IndexedDB ì—°ê²° ì˜¤ë¥˜:', event.target.error);
            };
        }

        /**
        * DBì—ì„œ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì—¬ ë‹‰ë„¤ì„ íƒœê·¸ë¥¼ ìƒì„±í•˜ê³  ì¶”ê°€í•©ë‹ˆë‹¤.
        */
        async function loadAndDisplayTags() {
            // 1. DB ì—°ê²° í™•ì¸
            if (!db) {
                console.error("IndexedDB ì—°ê²°ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                // í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì„œ openDatabase()ë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•˜ì—¬ ì—°ê²°ì„ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                return;
            }

            const container = document.querySelector('.search-history-container');
            if (!container) return;

            console.log('IndexedDB characters fetch and append tags');

            // ê¸°ì¡´ ë‚´ìš©ì„ ë¹„ì›ë‹ˆë‹¤.
            container.innerHTML = '';

            try {
                // 2. Promise ê¸°ë°˜ì˜ getCharacters í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ìºë¦­í„° ë°ì´í„° ì¡°íšŒ
                // (getCharacters í•¨ìˆ˜ê°€ Promiseë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ await ì‚¬ìš© ê°€ëŠ¥)
                const characterList = await getCharacters();

                // 3. ì¡°íšŒëœ ë°ì´í„°ë¥¼ ìˆœíšŒí•˜ë©° íƒœê·¸ ìƒì„±
                characterList.forEach(charactersObject => {
                    for (const [serverId, serverCharacters] of Object.entries(charactersObject)) {
                        Object.keys(serverCharacters).forEach((nickname) => {
                            const serverName = serverData.find(((server) => server.serverId === serverId)).serverName;
                            const tag = createNicknameTag(serverName, nickname);
                            container.appendChild(tag);
                        })
                    }
                });

            } catch (error) {
                console.error("ë°ì´í„° ì¡°íšŒ ë° íƒœê·¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                container.innerHTML = '<li>ê²€ìƒ‰ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>';
            }
        }

        function getCharacters() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([CHARACTER_STORE], 'readonly');
                const store = transaction.objectStore(CHARACTER_STORE);

                // ì»¤ì„œë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ë°ì´í„°ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
                const request = store.openCursor();
                let results = [];

                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        results.push(cursor.value);
                        cursor.continue();
                    } else {
                        resolve(results); // ëª¨ë“  ë°ì´í„° ë°°ì—´ì„ resolve
                    }
                };

                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }


        /**
         * ê°œë³„ ë‹‰ë„¤ì„ íƒœê·¸ (HTML ìš”ì†Œ)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
         */
        function createNicknameTag(serverName, nickname) {
            const tagDiv = document.createElement('div');
            tagDiv.className = 'nickname-tag';

            // ì„œë²„ ì´ë¦„ ìš”ì†Œ
            const serverSpan = document.createElement('span');
            serverSpan.className = 'server-name';
            serverSpan.textContent = serverName;

            // ë‹‰ë„¤ì„ ìš”ì†Œ
            const nicknameSpan = document.createElement('span');
            nicknameSpan.className = 'nickname-text';
            nicknameSpan.textContent = nickname;

            // ì‚­ì œ ë²„íŠ¼ ìš”ì†Œ
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'x';

            // ì‚­ì œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            removeBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                // IndexedDB ì‚­ì œ ë¡œì§ (ë³„ë„ì˜ í•¨ìˆ˜ í•„ìš”)
                console.log(`[${serverName}] ${nickname} ì‚­ì œ ìš”ì²­`);
                deleteCharacter(serverName, nickname);
                tagDiv.remove(); // DOMì—ì„œë„ ì¦‰ì‹œ ì œê±°
            });

            tagDiv.appendChild(serverSpan);
            tagDiv.appendChild(nicknameSpan);
            tagDiv.appendChild(removeBtn);
            tagDiv.onclick = () => handleTagClick(serverName, nickname)

            return tagDiv;
        }

        function handleTagClick(serverName, nickname) {
            SERVER_ID = serverData.find((server) => server.serverName === serverName).serverId;
            charInput.value = nickname;
            startSearch();
        }

        function deleteCharacter(serverName, nickname) {
            const transaction = db.transaction([CHARACTER_STORE], 'readwrite');
            const store = transaction.objectStore(CHARACTER_STORE);

            const getReq = store.get(DEFAULT_ID);

            getReq.onsuccess = (event) => {
                const characterObject = event.target.result;

                const character = characterObject[serverName][nickname];
                if (character) {
                    delete characterObject[serverName][nickname];
                    store.put(character, DEFAULT_ID);
                }
            }

            getReq.onerror = (event) => {
                console.error(`ìºë¦­í„° ë¦¬ìŠ¤íŠ¸ ì‚­ì œ ì‹¤íŒ¨`, event);
            };
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ DB ì—°ê²° ì‹œì‘
        openDatabase();
    </script>

</body>

</html>